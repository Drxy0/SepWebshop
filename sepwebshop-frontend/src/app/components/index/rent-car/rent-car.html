<div *ngIf="selectedCar">
  <h2 class="text-2xl font-bold text-gray-900 mb-2 border-b pb-4 tracking-tight">
    Booking Details
  </h2>

  <div
    class="bg-blue-50 rounded-2xl p-4 mb-6 mt-4 flex justify-between items-center border border-blue-100 shadow-sm"
  >
    <div>
      <p class="text-[10px] font-extrabold text-blue-400 uppercase tracking-widest">
        Selected Vehicle
      </p>
      <p class="text-lg font-bold text-blue-900">{{ selectedCar.brandAndModel }}</p>
    </div>
    <div class="text-right">
      <p class="text-[10px] font-extrabold text-blue-400 uppercase tracking-widest">Daily Rate</p>
      <p class="text-lg font-bold text-blue-900">{{ selectedCar.price }} $</p>
    </div>
  </div>

  <form [formGroup]="rentForm" (ngSubmit)="confirmBooking()" class="space-y-6">
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block text-[10px] font-bold uppercase text-gray-400 mb-2 ml-1"
          >Start Date</label
        >
        <input
          type="date"
          [min]="minDate"
          formControlName="leaseStartDate"
          [ngClass]="{
            'border-red-500 bg-red-50':
              rentForm.get('leaseStartDate')?.invalid && rentForm.get('leaseStartDate')?.touched
          }"
          class="w-full border-2 border-gray-100 rounded-xl px-4 py-3 focus:border-blue-500 outline-none transition bg-white"
        />
      </div>

      <div>
        <label class="block text-[10px] font-bold uppercase text-gray-400 mb-2 ml-1"
          >End Date</label
        >
        <input
          type="date"
          [min]="minDate"
          formControlName="leaseEndDate"
          [ngClass]="{'border-red-500 bg-red-50': (rentForm.get('leaseEndDate')?.invalid || rentForm.errors?.['dateOrderInvalid'] || rentForm.errors?.['dateOverlap']) && rentForm.get('leaseEndDate')?.touched}"
          class="w-full border-2 border-gray-100 rounded-xl px-4 py-3 focus:border-blue-500 outline-none transition bg-white"
        />
      </div>
    </div>

    <div
      *ngIf="rentForm.errors?.['dateOverlap']"
      class="bg-red-50 border-2 border-red-100 p-4 rounded-2xl animate-in fade-in slide-in-from-top-2 duration-300"
    >
      <div class="flex items-start gap-3">
        <span class="text-xl">⚠️</span>
        <div>
          <p class="text-red-800 font-bold text-sm">Dates are already taken!</p>
          <p class="text-red-600 text-xs mt-1">
            This car is booked from
            <span
              class="font-bold underline"
              *ngFor="let c of conflictingOrders(); let last = last"
            >
              {{ c.leaseStartDate | date : 'dd.MM' }} to {{ c.leaseEndDate | date : 'dd.MM'
              }}{{ !last ? ', ' : '' }} </span
            >.
          </p>
          <p class="text-red-500 text-[10px] mt-2 italic font-medium uppercase">
            Please choose other dates.
          </p>
        </div>
      </div>
    </div>

    <p
      *ngIf="rentForm.errors?.['dateOrderInvalid'] && (rentForm.get('leaseEndDate')?.touched || rentForm.get('leaseStartDate')?.touched)"
      class="text-red-500 text-xs font-bold text-center bg-red-50 p-3 rounded-xl border border-red-100"
    >
      The end date must be after the start date.
    </p>

    <div>
      <label class="block text-[10px] font-bold uppercase text-gray-400 mb-2 ml-1"
        >Insurance Plan</label
      >
      <div class="relative">
        <select
          formControlName="insuranceId"
          class="w-full border-2 border-gray-100 rounded-xl px-4 py-3 focus:border-blue-500 outline-none transition bg-white cursor-pointer appearance-none shadow-sm"
        >
          <option value="" disabled selected>Select coverage...</option>
          <option *ngFor="let ins of insurances()" [value]="ins.id">
            {{ ins.name }} (+{{ ins.pricePerDay }} $/day) +{{ ins.deductibleAmount }} $
          </option>
        </select>
        <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400">
          ▼
        </div>
      </div>
    </div>

    <div
      class="p-5 bg-gray-50 rounded-2xl border-2 border-dashed border-gray-200 space-y-3"
      *ngIf="calculateDays() > 0 && rentForm.valid"
    >
      <div class="flex justify-between text-xs font-medium uppercase tracking-wider text-gray-500">
        <span>Rental Duration</span>
        <span class="text-gray-900 font-bold">{{ calculateDays() }} day(s)</span>
      </div>
      <div class="flex justify-between items-center pt-3 border-t-2 border-gray-200">
        <span class="text-blue-900 font-bold text-lg uppercase tracking-tight">Total Price</span>
        <span class="text-2xl font-black text-blue-600 tracking-tighter"
          >{{ calculateTotal() }} $</span
        >
      </div>
    </div>

    <div class="flex items-center gap-4 pt-4">
      <button
        type="button"
        (click)="cancel()"
        class="flex-1 py-4 font-bold text-gray-400 hover:text-gray-600 transition-all hover:bg-gray-100 rounded-2xl"
      >
        Cancel
      </button>
      <button
        type="submit"
        [disabled]="rentForm.invalid || isSubmitting()"
        class="flex-2 bg-blue-600 text-white py-4 rounded-2xl font-extrabold hover:bg-blue-700 disabled:opacity-30 disabled:grayscale transition-all shadow-xl shadow-blue-200 active:scale-95"
      >
        {{ isSubmitting() ? 'Processing...' : 'Confirm and Pay' }}
      </button>
    </div>
  </form>
</div>
